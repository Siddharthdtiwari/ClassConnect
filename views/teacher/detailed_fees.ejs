<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detailed Fees Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Inter", sans-serif;
    }

    .text-brand-purple {
      color: #5d3a9b;
    }

    .report-table {
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.875rem;
    }

    .report-table th,
    .report-table td {
      padding: 0;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
      background-color: #ffffff;
      height: 4rem;
    }

    .cell-content,
    .header-content {
      padding: 0.75rem;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sticky-col-left .cell-content,
    .sticky-col-left .header-content {
      justify-content: flex-start;
      text-align: left;
      padding-left: 1rem;
      width: 240px;
    }

    .overflow-x-auto {
      max-height: calc(100vh - 200px);
      overflow: auto;
    }

    .report-table th {
      position: sticky;
      top: 0;
      z-index: 40;
      background-color: #f9fafb;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .sticky-col-left {
      position: sticky;
      left: 0;
      z-index: 35;
      box-shadow: 2px 0 5px -2px rgba(0, 0, 0, 0.1);
      font-weight: 500;
    }

    tbody .sticky-col-left {
      background-color: #ffffff !important;
    }

    th.sticky-col-left {
      z-index: 45;
    }

    .sticky-col-right-overall {
      position: sticky;
      right: 0;
      z-index: 30;
      box-shadow: -2px 0 5px -2px rgba(0, 0, 0, 0.1);
      width: 150px;
    }

    th.sticky-col-right-overall {
      z-index: 44;
      background-color: #f3e8ff;
    }

    td.sticky-col-right-overall {
      background-color: #f7f9fc !important;
      font-weight: 600;
    }

    .cell-paid .cell-content {
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
      text-align: left;
      padding-left: 0.75rem;
    }

    .cell-paid .amount {
      color: #10b981;
      font-weight: 700;
      font-size: 1rem;
    }

    .cell-paid .date-method {
      font-size: 0.75rem;
      color: #4b5563;
    }

    .cell-unpaid .cell-content {
      color: #ef4444;
      font-weight: 500;
      font-style: italic;
      font-size: 0.875rem;
    }

    .overall-summary-content {
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
      text-align: left;
      padding-left: 1rem;
      font-size: 0.875rem;
    }

    .overall-summary-content div {
      padding: 1px 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
    }

    .overall-summary-content .value {
      font-weight: 700;
    }

    .overall-summary-content .total-paid .value {
      color: #10b981;
      font-size: 1rem;
    }

    .overall-summary-content .total-due .value {
      color: #374151;
    }

    .overall-summary-content .balance-due .value {
      color: #ef4444;
      font-size: 1rem;
    }

    .overall-summary-content .balance-ok .value {
      color: #10b981;
      font-size: 1rem;
    }

    @media (max-width: 1023px) {

      .report-table th.sticky-col-right-overall,
      .report-table td.sticky-col-right-overall {
        position: relative;
        z-index: 1;
        right: auto;
        box-shadow: none;
        width: auto;
      }
    }
  </style>
</head>

<%- include('../partials/background') %>

<body class="text-gray-800">
  <div class="content-container container mx-auto p-4 sm:p-6 lg:p-8 min-h-screen">
    <header class="mb-8">
      <a href="/teacher/manage_fees" class="text-sm text-brand-purple hover:underline mb-2 block">&larr; Back to Manage Fees</a>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900">
        Detailed Fees Report
      </h1>
      <p class="text-gray-600 mt-1">
        View detailed payment status, amount, and totals for each student.
      </p>
    </header>

    <div class="bg-white p-2 sm:p-4 rounded-xl shadow-xl">
      <div class="overflow-x-auto">
        <table class="report-table w-full border-collapse min-w-max">
          <thead>
            <tr>
              <th class="sticky-col-left">
                <div class="header-content">Student Name / ID</div>
              </th>

              <% months.forEach(month => { %>
              <th>
                <div class="header-content"><%= month %></div>
              </th>
              <% }) %>

              <th class="sticky-col-right-overall">
                <div class="header-content">Overall Summary</div>
              </th>
            </tr>
          </thead>
          <tbody>
            <% if (report && report.length > 0) { %>
            <% report.forEach(student => { %>
            <tr class="hover:bg-gray-50">
              <td class="sticky-col-left text-brand-purple">
                <div class="cell-content">
                  <div>
                    <%= student.studentName %><br>
                    <span class="text-xs text-gray-500 font-normal">(<%= student.studentId %>)</span>
                  </div>
                </div>
              </td>

              <% months.forEach(month => { %>
              <% const record = student.records[month]; %>
              <% if (record.status === 'Paid') { %>
              <td class="cell-paid">
                <div class="cell-content">
                  <span class="amount">₹<%= record.amount.toLocaleString() %></span>
                  <span class="date-method">
                    <%= record.datePaid.toLocaleDateString() %> | <%= record.method %>
                  </span>
                </div>
              </td>
              <% } else { %>
              <td class="cell-unpaid">
                <div class="cell-content">Unpaid</div>
              </td>
              <% } %>
              <% }) %>

              <td class="sticky-col-right-overall">
                <div class="cell-content overall-summary-content">
                  <div class="total-due">
                    <span>Due:</span>
                    <span class="value">₹<%= student.totalDue.toLocaleString() %></span>
                  </div>
                  <div class="total-paid">
                    <span>Paid:</span>
                    <span class="value">₹<%= student.totalPaid.toLocaleString() %></span>
                  </div>

                  <% if (student.balance < 0) { %>
                  <div class="balance-ok">
                    <span>Credit:</span>
                    <span class="value">₹<%= Math.abs(student.balance).toLocaleString() %></span>
                  </div>
                  <% } else if (student.balance > 0) { %>
                  <div class="balance-due">
                    <span>Balance:</span>
                    <span class="value">₹<%= student.balance.toLocaleString() %></span>
                  </div>
                  <% } else { %>
                  <div class="balance-ok">
                    <span>Balance:</span>
                    <span class="value">₹0</span>
                  </div>
                  <% } %>

                </div>
              </td>
            </tr>
            <% }) %>
            <% } else { %>
            <tr>
              <td colspan="<%= months.length + 2 %>" class="text-center py-8 text-gray-500">
                <div class="cell-content" style="justify-content: center;">
                  No student or fee records found.
                </div>
              </td>
            </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body>

</html>